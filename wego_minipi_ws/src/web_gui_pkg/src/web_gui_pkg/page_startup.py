# src/web_gui_pkg/src/web_gui_pkg/page_startup.py

from nicegui import ui
import os
import stat
import glob
import shutil
from .core_logic import NiceGUIRos_instance
from .config import ROBOT_NAME, HOME_DIR, ROS_SETUP_COMMAND

@ui.page("/startup")
def startup_page():
    
    # [ì„¤ì •] ë””ë ‰í† ë¦¬ êµ¬ì¡°
    STARTUP_ROOT = os.path.join(HOME_DIR, "startup")
    DEFAULT_DIR = os.path.join(STARTUP_ROOT, "default")
    ADDITIONAL_DIR = os.path.join(STARTUP_ROOT, "additional")
    
    os.makedirs(DEFAULT_DIR, exist_ok=True)
    os.makedirs(ADDITIONAL_DIR, exist_ok=True)

    AUTOSTART_DIR = os.path.join(HOME_DIR, ".config", "autostart")
    MY_DESKTOP_FILE = os.path.join(AUTOSTART_DIR, "wego_gui_user_startup.desktop")
    WRAPPER_SCRIPT = os.path.join(STARTUP_ROOT, "launcher_wrapper.sh")

    checkboxes = {}
    
    # UI ì°¸ì¡° ë³€ìˆ˜ (ë°˜ì‘í˜• ì œì–´ë¥¼ ìœ„í•´)
    user_list_card = None 

    # ----- í—¤ë” -----
    with ui.header().classes("bg-slate-900 shadow-lg"):
        with ui.row().classes("w-full items-center h-full max-w-screen-xl mx-auto px-4"):
            ui.html("""<img src="/static/wego_logo.png" style="height: 32px;">""")
            ui.label(ROBOT_NAME + " Startup Manager").classes("text-white font-bold text-lg")
            ui.space()
            ui.button("ë©”ì¸ìœ¼ë¡œ", icon="home", color="indigo-6").props("flat").on(
                "click", lambda: ui.navigate.to("/", new_tab=False)
            )

    # ========================================================
    # [Logic] ê¸°ëŠ¥ êµ¬í˜„
    # ========================================================
    def open_save_dialog():
        with ui.dialog() as dialog, ui.card():
            ui.label("ìƒˆ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±").classes("text-lg font-bold")
            name_input = ui.input("íŒŒì¼ ì´ë¦„ (ì˜ˆ: kid_mode)", placeholder="start_up").classes("w-full")
            
            def _save():
                name = name_input.value.strip()
                if not name:
                    ui.notify("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", type="warning"); return
                if not name.endswith(".sh"): name += ".sh"
                
                save_path = os.path.join(ADDITIONAL_DIR, name)
                create_script_file(save_path)
                dialog.close()
                ui.navigate.reload()

            with ui.row().classes("w-full justify-end"):
                ui.button("ì·¨ì†Œ", on_click=dialog.close).props("flat")
                ui.button("ì €ì¥", on_click=_save)
        dialog.open()

    def create_script_file(path):
        selected_items = []
        for (pkg, file_name), cb in checkboxes.items():
            if cb.value: selected_items.append((pkg, file_name))

        if not selected_items:
            ui.notify("ì„ íƒëœ Launch íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.", type="warning"); return

        try:
            with open(path, "w") as f:
                f.write("#!/bin/bash\n\n")
                f.write("# Auto-generated by Web GUI\n")
                setup_cmds = ROS_SETUP_COMMAND.split(";")
                for cmd in setup_cmds:
                    if cmd.strip(): f.write(f"{cmd.strip()}\n")
                
                f.write("\n# Launch selected packages\n")
                for pkg, file_name in selected_items:
                    if pkg == "web_gui_pkg" and file_name == "cam_setting.launch": continue
                    
                    cmd = f"roslaunch {pkg} {file_name}"
                    if pkg == "usb_cam" and file_name == "usb_cam-test.launch":
                        cmd += " video_device:=/dev/video0"
                    
                    f.write(f"echo 'Starting {file_name}...'\n")
                    f.write(f"{cmd} &\n") 
                    f.write("sleep 2\n\n")
                f.write("wait\n")

            st = os.stat(path)
            os.chmod(path, st.st_mode | stat.S_IEXEC)
            ui.notify(f"ìƒì„± ì™„ë£Œ: {os.path.basename(path)}", type="positive")
        except Exception as e:
            ui.notify(f"ìƒì„± ì‹¤íŒ¨: {e}", type="negative")

    def update_list_ui_state(is_on):
        """ìŠ¤ìœ„ì¹˜ ìƒíƒœì— ë”°ë¼ ëª©ë¡ UIë¥¼ í™œì„±/ë¹„í™œì„± ì²˜ë¦¬"""
        if user_list_card:
            if is_on:
                # í™œì„±í™”: íˆ¬ëª…ë„ ì œê±°, í´ë¦­ ê°€ëŠ¥
                user_list_card.classes(remove="opacity-40 pointer-events-none grayscale")
            else:
                # ë¹„í™œì„±í™”: íë¦¬ê²Œ, í‘ë°±, í´ë¦­ ë¶ˆê°€
                user_list_card.classes(add="opacity-40 pointer-events-none grayscale")

    def toggle_global_autostart(e):
        is_on = e.value
        # UI ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
        update_list_ui_state(is_on)

        if is_on: # ON
            try:
                os.makedirs(AUTOSTART_DIR, exist_ok=True)
                with open(WRAPPER_SCRIPT, "w") as f:
                    f.write("#!/bin/bash\n")
                    f.write(f"{ROS_SETUP_COMMAND}\n\n")
                    f.write("echo '======================================'\n")
                    f.write("echo '   Wego GUI User Startup Launcher     '\n")
                    f.write("echo '======================================'\n\n")
                    f.write("echo 'Waiting 50 seconds for Robot Initialization...'\n")
                    f.write("for i in {50..1}; do echo -ne \"Running in $i seconds... \\r\"; sleep 1; done\n")
                    f.write("echo -e \"\\n[Launcher] Timer finished. Checking ROS...\"\n\n")
                    f.write("until rostopic list > /dev/null 2>&1; do echo 'Waiting for ROS Master...'; sleep 2; done\n")
                    f.write("echo '[Launcher] ROS Ready! Executing enabled user scripts...'\n\n")
                    f.write(f"for f in {ADDITIONAL_DIR}/*.sh; do\n")
                    f.write("  if [ -f \"$f\" ]; then echo \"[Launcher] Running $f ...\"; bash \"$f\" & fi\n")
                    f.write("done\n\n")
                    f.write("echo '[Launcher] All scripts triggered.'\n")
                    f.write("wait\n")
                    f.write("sleep 1000\n") 

                st = os.stat(WRAPPER_SCRIPT)
                os.chmod(WRAPPER_SCRIPT, st.st_mode | stat.S_IEXEC)

                term_cmd = ""
                if shutil.which("gnome-terminal"):
                    term_cmd = f"gnome-terminal --window --title='User Scripts Launcher' -- bash -c '{WRAPPER_SCRIPT}; exec bash'"
                elif shutil.which("xfce4-terminal"):
                    term_cmd = f"xfce4-terminal --title='User Scripts Launcher' --hold --command='bash -c {WRAPPER_SCRIPT}'"
                else:
                    term_cmd = f"x-terminal-emulator -e 'bash -c \"{WRAPPER_SCRIPT}; read\"'"

                with open(MY_DESKTOP_FILE, "w") as f:
                    f.write("[Desktop Entry]\n")
                    f.write("Type=Application\n")
                    f.write("Name=Wego GUI User Startup\n")
                    f.write(f"Exec={term_cmd}\n")
                    f.write("Hidden=false\n")
                    f.write("NoDisplay=false\n")
                    f.write("X-GNOME-Autostart-enabled=true\n")
                
                ui.notify(f"ìë™ ì‹¤í–‰ ë“±ë¡ë¨! (ë¶€íŒ… 50ì´ˆ í›„ ì‹¤í–‰)", type="positive")
            except Exception as err:
                ui.notify(f"ì„¤ì • ì‹¤íŒ¨: {err}", type="negative"); e.source.set_value(False)
        else: # OFF
            if os.path.exists(MY_DESKTOP_FILE): os.remove(MY_DESKTOP_FILE)
            if os.path.exists(WRAPPER_SCRIPT): os.remove(WRAPPER_SCRIPT)
            ui.notify("ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ ìë™ ì‹¤í–‰: êº¼ì§", type="warning")

    def toggle_file_status(e, name):
        base_path = os.path.join(ADDITIONAL_DIR, name)
        target_path = base_path + ".sh"
        disabled_path = base_path + ".sh.disabled"

        if e.value: # ON
            if os.path.exists(disabled_path):
                os.rename(disabled_path, target_path)
                ui.notify(f"{name} í™œì„±í™”ë¨", type="positive")
            elif os.path.exists(target_path): pass
            else: ui.notify("íŒŒì¼ ì˜¤ë¥˜", type="negative"); e.source.set_value(False)
        else: # OFF
            if os.path.exists(target_path):
                os.rename(target_path, disabled_path)
                ui.notify(f"{name} ë¹„í™œì„±í™”ë¨", type="warning")
            elif os.path.exists(disabled_path): pass
            else: ui.notify("íŒŒì¼ ì˜¤ë¥˜", type="negative"); e.source.set_value(True)

    def delete_file(name):
        p1 = os.path.join(ADDITIONAL_DIR, name + ".sh")
        p2 = os.path.join(ADDITIONAL_DIR, name + ".sh.disabled")
        try:
            if os.path.exists(p1): os.remove(p1)
            if os.path.exists(p2): os.remove(p2)
            ui.notify(f"{name} ì‚­ì œë¨", type="info")
            ui.navigate.reload()
        except Exception as e:
            ui.notify(f"ì‚­ì œ ì‹¤íŒ¨: {e}", type="negative")

    def get_additional_files():
        files = glob.glob(os.path.join(ADDITIONAL_DIR, "*"))
        result = []
        for f in files:
            fname = os.path.basename(f)
            if fname.endswith(".sh"):
                result.append({"name": fname[:-3], "enabled": True})
            elif fname.endswith(".sh.disabled"):
                result.append({"name": fname[:-12], "enabled": False})
        return sorted(result, key=lambda x: x["name"])

    # --------------------------------------------------------
    # [UI] ë ˆì´ì•„ì›ƒ
    # --------------------------------------------------------
    with ui.column().classes("p-4 w-full max-w-screen-xl mx-auto space-y-6"):
        
        # 1. ì‹œìŠ¤í…œ ê´€ë¦¬
        with ui.card().classes("w-full border-l-4 border-slate-500"):
            ui.label("âš™ï¸ ë¶€íŒ… í”„ë¡œì„¸ìŠ¤ ê´€ë¦¬ (System & Startup)").classes("text-xl font-bold")
            
            with ui.row().classes("w-full items-center justify-between px-4 py-3 bg-gray-100 rounded"):
                with ui.column().classes("gap-0"):
                    ui.label("1. Default System (Factory)").classes("font-bold text-gray-700")
                    ui.label(f"ê²½ë¡œ: {DEFAULT_DIR}").classes("text-xs text-gray-400")
                ui.chip("Always ON", color="gray", icon="lock").props("dense")

            with ui.row().classes("w-full items-center justify-between px-4 py-3 bg-indigo-50 rounded mt-2"):
                is_global_on = os.path.exists(MY_DESKTOP_FILE)
                with ui.column().classes("gap-0"):
                    ui.label("2. User Scripts (Additional)").classes("font-bold text-indigo-700")
                    ui.label("í™œì„±í™” ì‹œ, ë¶€íŒ… ì§í›„ í„°ë¯¸ë„ì´ ì—´ë¦¬ê³  50ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ í›„ ì‹¤í–‰ë©ë‹ˆë‹¤.").classes("text-xs text-indigo-500")
                ui.switch("ë¶€íŒ… ì‹œ ì‹¤í–‰", value=is_global_on, on_change=toggle_global_autostart).props("color=indigo size=lg")

        # 2. ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ (UI ë³€ìˆ˜ì— í• ë‹¹í•˜ì—¬ ìƒíƒœ ì œì–´)
        user_list_card = ui.card().classes("w-full border-l-4 border-green-500 transition-all duration-300")
        with user_list_card:
            with ui.row().classes("w-full items-center justify-between"):
                with ui.column().classes("gap-0"):
                    ui.label("ğŸ“‚ ì‚¬ìš©ì ìŠ¤í¬ë¦½íŠ¸ ëª©ë¡").classes("text-xl font-bold")
                    ui.label(f"ê²½ë¡œ: {ADDITIONAL_DIR}").classes("text-xs text-gray-500")
                ui.button(icon="refresh", on_click=lambda: ui.navigate.reload()).props("flat round")

            # [ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€]
            ui.label("ğŸ’¡ ì•Œë¦¼: ëª©ë¡ì„ ë³€ê²½(ON/OFF)í•œ í›„ì—ëŠ” ìˆœì„œ ì ìš©ì„ ìœ„í•´ ìƒë‹¨ì˜ [ë¶€íŒ… ì‹œ ì‹¤í–‰] ìŠ¤ìœ„ì¹˜ë¥¼ ê»ë‹¤ê°€ ë‹¤ì‹œ ì¼œì£¼ì„¸ìš”.").classes(
                "w-full text-sm text-orange-800 bg-orange-100 p-2 rounded mb-2 font-medium"
            )

            user_files = get_additional_files()
            if not user_files:
                ui.label("ì €ì¥ëœ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ìƒì„±í•´ì£¼ì„¸ìš”.").classes("text-gray-400 italic ml-4 py-4")
            else:
                with ui.grid(columns=1).classes("w-full gap-2 mt-2 lg:grid-cols-2"):
                    for item in user_files:
                        with ui.row().classes("items-center justify-between px-4 py-2 bg-green-50 rounded border border-green-100"):
                            ui.label(item["name"] + ".sh").classes("font-medium")
                            with ui.row().classes("items-center"):
                                ui.switch(value=item["enabled"], on_change=lambda e, n=item["name"]: toggle_file_status(e, n)).props("color=green")
                                ui.button(icon="delete", color="red", on_click=lambda _, n=item["name"]: delete_file(n)).props("flat dense round")

        # ì´ˆê¸° UI ìƒíƒœ ì ìš© (ìŠ¤ìœ„ì¹˜ êº¼ì ¸ìˆìœ¼ë©´ íë¦¬ê²Œ)
        if not is_global_on:
            user_list_card.classes(add="opacity-40 pointer-events-none grayscale")

        # 3. ìƒì„±ê¸°
        with ui.card().classes("w-full"):
            with ui.row().classes("w-full items-center justify-between mb-4"):
                ui.label("ğŸ“ ìƒˆ ìŠ¤í¬ë¦½íŠ¸ ë§Œë“¤ê¸°").classes("text-xl font-bold")
                ui.button("ì €ì¥ (.sh ìƒì„±)", icon="save", color="green-6", on_click=open_save_dialog)

            if not NiceGUIRos_instance.launch_files_data:
                ui.spinner('dots', size='lg')
                ui.label("íŒ¨í‚¤ì§€ ìŠ¤ìº” ì¤‘...")
            else:
                with ui.column().classes("w-full gap-4"):
                    for pkg, pkg_data in sorted(NiceGUIRos_instance.launch_files_data.items()):
                        if pkg == "web_gui_pkg": continue 
                        with ui.expansion(f"ğŸ“¦ {pkg}", icon="folder", value=True).classes("w-full bg-slate-50"):
                            with ui.grid(columns=1).classes("w-full gap-2 p-2 sm:grid-cols-2 lg:grid-cols-3"):
                                for file_name in sorted(pkg_data["files"].keys()):
                                    if file_name == "cam_setting.launch": continue
                                    with ui.row().classes("items-center"):
                                        cb = ui.checkbox(file_name)
                                        checkboxes[(pkg, file_name)] = cb

    with ui.footer().classes("justify-center items-center h-6 bg-gray-200"):
        ui.label("Startup Manager v5.7 (UX Improved)").classes("text-xs text-gray-500")