# src/web_gui_pkg/src/web_gui_pkg/page_startup.py

from nicegui import ui
import os
import stat
from .core_logic import NiceGUIRos_instance
from .config import ROBOT_NAME, HOME_DIR, ROS_SETUP_COMMAND


@ui.page("/startup")
def startup_page():
    # ìŠ¤í¬ë¦½íŠ¸ ì €ì¥ ê²½ë¡œ
    SCRIPT_PATH = "/home/hightorque/start_up.sh"

    # ì„ íƒëœ í•­ëª©ì„ ì €ì¥í•  ë”•ì…”ë„ˆë¦¬ {(pkg_name, file_name): checkbox_element}
    checkboxes = {}

    # ----- í—¤ë” -----
    with ui.header().classes("bg-slate-900 shadow-lg"):
        with ui.row().classes("w-full items-center h-full max-w-screen-xl mx-auto px-4"):
            ui.html("""<img src="/static/wego_logo.png" style="height: 32px;">""")
            ui.label(ROBOT_NAME + " Startup Generator").classes("text-white font-bold text-lg")
            ui.space()
            ui.button("ë¶€íŒ… ì„¤ì •", icon="save_as", color="green-6").props("flat").on("click", lambda: ui.navigate.to("/startup", new_tab=False))
            ui.button("ë©”ì¸ìœ¼ë¡œ", icon="home", color="indigo-6").props("flat").on("click", lambda: ui.navigate.to("/", new_tab=False))

    # ----- ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ë¡œì§ -----
    def generate_script():
        selected_items = []
        for (pkg, file_name), cb in checkboxes.items():
            if cb.value:
                selected_items.append((pkg, file_name))

        if not selected_items:
            ui.notify("ì„ íƒëœ Launch íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.", type="warning")
            return

        try:
            with open(SCRIPT_PATH, "w") as f:
                f.write("#!/bin/bash\n\n")
                f.write("# Auto-generated by Web GUI\n")

                # config.pyì— ìˆëŠ” ROS setup ëª…ë ¹ì–´ë“¤ì„ ì¤„ë°”ê¿ˆí•´ì„œ ë„£ê¸°
                # (ì„¸ë¯¸ì½œë¡ ìœ¼ë¡œ êµ¬ë¶„ëœ ëª…ë ¹ì–´ë¥¼ ë³´ê¸° ì¢‹ê²Œ ë¶„ë¦¬)
                setup_cmds = ROS_SETUP_COMMAND.split(";")
                for cmd in setup_cmds:
                    if cmd.strip():
                        f.write(f"{cmd.strip()}\n")

                f.write("\n# Wait for ROS Core (Optional but recommended)\n")
                f.write("sleep 1\n\n")

                f.write("# Launch selected packages\n")
                for pkg, file_name in selected_items:
                    # cam_setting.launch ê°™ì€ ê°€ìƒ íŒŒì¼ ì œì™¸
                    if pkg == "web_gui_pkg" and file_name == "cam_setting.launch":
                        continue

                    cmd = f"roslaunch {pkg} {file_name}"
                    # usb_camì˜ ê²½ìš° ì¸ì ì¶”ê°€ ì˜ˆì‹œ (í•„ìš”ì‹œ ë¡œì§ êµ¬ì²´í™”)
                    if pkg == "usb_cam" and file_name == "usb_cam-test.launch":
                        # ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥
                        cmd += " video_device:=/dev/video0"

                    f.write(f"echo 'Starting {file_name}...'\n")
                    f.write(f"{cmd} &\n")  # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
                    f.write("sleep 2\n\n")  # ì‹¤í–‰ ê°„ê²© í…€

                f.write("wait\n")

            # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (+x)
            st = os.stat(SCRIPT_PATH)
            os.chmod(SCRIPT_PATH, st.st_mode | stat.S_IEXEC)

            ui.notify(f"ìƒì„± ì™„ë£Œ: {SCRIPT_PATH}", type="positive")

        except Exception as e:
            ui.notify(f"ìƒì„± ì‹¤íŒ¨: {e}", type="negative")

    # ----- ë©”ì¸ UI -----
    with ui.column().classes("p-4 w-full max-w-screen-xl mx-auto"):
        ui.label("ë¶€íŒ… ì‹œ ì‹¤í–‰í•  Launch íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”").classes("text-xl font-bold mb-4")

        # ìŠ¤ìº” ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê²½ê³ 
        if not NiceGUIRos_instance.launch_files_data:
            ui.label("íŒ¨í‚¤ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ê±°ë‚˜ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ì—ì„œ ìŠ¤ìº”ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.").classes("text-red-500")
            ui.button("ìƒˆë¡œê³ ì¹¨", icon="refresh", on_click=lambda: ui.navigate.reload())
        else:
            with ui.row().classes("w-full mb-4 justify-end"):
                ui.button("ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (start_up.sh)", icon="save", color="green-6", on_click=generate_script)

            # íŒ¨í‚¤ì§€ë³„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            with ui.column().classes("w-full gap-4"):
                for pkg, pkg_data in sorted(NiceGUIRos_instance.launch_files_data.items()):
                    # ê°€ìƒ íŒ¨í‚¤ì§€ë‚˜ íŒŒì¼ ì œì™¸í•˜ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ í•„í„°ë§

                    with ui.card().classes("w-full"):
                        ui.label(f"ğŸ“¦ {pkg}").classes("text-lg font-bold bg-slate-100 w-full p-2 rounded")

                        with ui.grid(columns=1).classes("w-full gap-2 p-2 sm:grid-cols-2 lg:grid-cols-3"):
                            for file_name in sorted(pkg_data["files"].keys()):
                                # cam_setting.launchëŠ” ì œì™¸
                                if file_name == "cam_setting.launch":
                                    continue

                                with ui.row().classes("items-center"):
                                    cb = ui.checkbox(file_name)
                                    checkboxes[(pkg, file_name)] = cb

    # ----- í‘¸í„° -----
    with ui.footer().classes("justify-center items-center h-6 bg-gray-200"):
        ui.label("Start Up Generator v1.0").classes("text-xs text-gray-500")
